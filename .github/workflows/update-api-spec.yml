name: Kintone APIä»•æ§˜æ›´æ–°

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 3:00 UTC (æ—¥æœ¬æ™‚é–“ 12:00)
    - cron: '0 3 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¤‰æ›´ãŒãªãã¦ã‚‚å¼·åˆ¶çš„ã«æ›´æ–°ã™ã‚‹'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: PHPç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: shivammathur/setup-php@2e947f1f6932d141d076ca441d0e1e881775e95b # v2.31.0
        with:
          php-version: '8.1'
          tools: composer

      - name: ç¾åœ¨ã®APIä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: current_version
        run: |
          if [ -d "rest-api-spec" ]; then
            CURRENT_VERSION=$(find rest-api-spec -maxdepth 1 -type d -name "20*" | sort -r | head -1 | xargs basename 2>/dev/null || echo "none")
          else
            CURRENT_VERSION="none"
          fi
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ç¾åœ¨ã®APIãƒãƒ¼ã‚¸ãƒ§ãƒ³: $CURRENT_VERSION"

      - name: æœ€æ–°ã®APIä»•æ§˜ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        run: |
          bash scripts/update-spec.sh

      - name: æœ€æ–°ã®APIä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: latest_version
        run: |
          LATEST_VERSION=$(find rest-api-spec -maxdepth 1 -type d -name "20*" | sort -r | head -1 | xargs basename 2>/dev/null || echo "none")
          echo "version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "æœ€æ–°ã®APIãƒãƒ¼ã‚¸ãƒ§ãƒ³: $LATEST_VERSION"

      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_version_changes
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.version }}"
          LATEST_VERSION="${{ steps.latest_version.outputs.version }}"
          FORCE_UPDATE="${{ github.event.inputs.force_update }}"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ] || [ "$FORCE_UPDATE" = "true" ]; then
            echo "has_version_changes=true" >> $GITHUB_OUTPUT
            echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ãŒæ¤œå‡ºã•ã‚ŒãŸã‹ã€å¼·åˆ¶æ›´æ–°ãŒè¦æ±‚ã•ã‚Œã¾ã—ãŸ"
          else
            echo "has_version_changes=false" >> $GITHUB_OUTPUT
            echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: ä¸Šæµãƒªãƒã‚¸ãƒˆãƒªæƒ…å ±ã‚’å–å¾—
        id: upstream_info
        if: steps.check_version_changes.outputs.has_version_changes == 'true'
        run: |
          # ä¸Šæµãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          UPSTREAM_REPO="kintone/rest-api-spec"
          LATEST_COMMIT=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/commits/main" | jq -r '.sha[:7]')
          LATEST_COMMIT_URL=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/commits/main" | jq -r '.html_url')
          LATEST_COMMIT_MESSAGE=$(curl -s "https://api.github.com/repos/$UPSTREAM_REPO/commits/main" | jq -r '.commit.message' | head -1)
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒç”¨ã®URLï¼ˆç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒnoneã®å ´åˆã¯å˜ç´”ãªã‚³ãƒŸãƒƒãƒˆãƒšãƒ¼ã‚¸ï¼‰
          if [ "${{ steps.current_version.outputs.version }}" = "none" ]; then
            COMPARE_URL="https://github.com/$UPSTREAM_REPO/commits/main"
          else
            COMPARE_URL="https://github.com/$UPSTREAM_REPO/compare/${{ steps.current_version.outputs.version }}...${{ steps.latest_version.outputs.version }}"
          fi
          
          echo "commit_sha=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          echo "commit_url=$LATEST_COMMIT_URL" >> $GITHUB_OUTPUT
          echo "commit_message=$LATEST_COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "compare_url=$COMPARE_URL" >> $GITHUB_OUTPUT

      - name: PHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ç”Ÿæˆ
        if: steps.check_version_changes.outputs.has_version_changes == 'true'
        run: |
          composer install --no-dev
          composer generate

      - name: ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã®å·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_code_changes
        if: steps.check_version_changes.outputs.has_version_changes == 'true'
        run: |
          # Gitã®è¨­å®šï¼ˆã‚³ãƒŸãƒƒãƒˆä½œæˆã®ãŸã‚ï¼‰
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          # ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
          git add src/
          
          # å·®åˆ†ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --cached --quiet; then
            echo "has_code_changes=false" >> $GITHUB_OUTPUT
            echo "ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
          else
            echo "has_code_changes=true" >> $GITHUB_OUTPUT
            echo "ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å–å¾—
            CHANGED_FILES=$(git diff --cached --name-only | wc -l)
            echo "changed_files_count=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: $CHANGED_FILES"
          fi

      - name: ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        if: steps.check_version_changes.outputs.has_version_changes == 'true' && steps.check_code_changes.outputs.has_code_changes == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v5.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Kintone APIä»•æ§˜ã‚’${{ steps.latest_version.outputs.version }}ã«æ›´æ–°
            
            - ${{ steps.current_version.outputs.version }} â†’ ${{ steps.latest_version.outputs.version }} ã«æ›´æ–°
            - PHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å†ç”Ÿæˆ
            - å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.check_code_changes.outputs.changed_files_count }}
            - ä¸Šæµã‚³ãƒŸãƒƒãƒˆ: ${{ steps.upstream_info.outputs.commit_sha }}
          title: "ğŸ”„ Kintone APIä»•æ§˜ã‚’ ${{ steps.latest_version.outputs.version }} ã«æ›´æ–°"
          body: |
            ## ğŸ”„ Kintone APIä»•æ§˜ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
            
            ã“ã®PRã¯Kintone REST APIä»•æ§˜ã‚’æ›´æ–°ã—ã€ãã‚Œã«åˆã‚ã›ã¦PHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å†ç”Ÿæˆã—ã¾ã™ã€‚
            
            ### ğŸ“Š å¤‰æ›´å†…å®¹
            - **æ›´æ–°å‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: `${{ steps.current_version.outputs.version }}`
            - **æ›´æ–°å¾Œãƒãƒ¼ã‚¸ãƒ§ãƒ³**: `${{ steps.latest_version.outputs.version }}`
            - **å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°**: ${{ steps.check_code_changes.outputs.changed_files_count }}å€‹
            - **ä¸Šæµã‚³ãƒŸãƒƒãƒˆ**: [`${{ steps.upstream_info.outputs.commit_sha }}`](${{ steps.upstream_info.outputs.commit_url }})
            - **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ${{ steps.upstream_info.outputs.commit_message }}
            
            ### ğŸ”— å‚è€ƒãƒªãƒ³ã‚¯
            - [ğŸ“‹ ä¸Šæµãƒªãƒã‚¸ãƒˆãƒªã®å¤‰æ›´ã‚’ç¢ºèª](${{ steps.upstream_info.outputs.compare_url }})
            - [ğŸ“– Kintone REST API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.kintone.io/hc/ja/categories/18815983)
            - [ğŸ”§ ç”Ÿæˆã•ã‚ŒãŸPHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å¤‰æ›´ã‚’ç¢ºèª](../../compare)
            
            ### âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            - [ ] ç”Ÿæˆã•ã‚ŒãŸPHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¯ãƒ©ã‚¹ã‚’ç¢ºèª
            - [ ] APIã®ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
            - [ ] å¿…è¦ã«å¿œã˜ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°
            - [ ] çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
            
            ### ğŸ“ ãƒ¡ãƒ¢
            ã“ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã¯é€±æ¬¡APIä»•æ§˜æ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚  
            ãƒãƒ¼ã‚¸ã™ã‚‹å‰ã«å¤‰æ›´å†…å®¹ã‚’å¿…ãšãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚
            
            ---
            ğŸ¤– *GitHub Actionsã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆ*
          branch: update/api-spec-${{ steps.latest_version.outputs.version }}
          delete-branch: true
          labels: |
            api-update
            automated
            dependencies

      - name: å®Ÿè¡Œçµæœã‚’å‡ºåŠ›
        run: |
          VERSION_CHANGED="${{ steps.check_version_changes.outputs.has_version_changes }}"
          CODE_CHANGED="${{ steps.check_code_changes.outputs.has_code_changes }}"
          
          if [ "$VERSION_CHANGED" = "false" ]; then
            echo "â„¹ï¸ APIä»•æ§˜ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          elif [ "$CODE_CHANGED" = "false" ]; then
            echo "âš ï¸ APIä»•æ§˜ã¯ ${{ steps.latest_version.outputs.version }} ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸãŒã€ç”Ÿæˆã•ã‚ŒãŸPHPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "ã“ã®å ´åˆã€PRã¯ä½œæˆã•ã‚Œã¾ã›ã‚“"
          else
            echo "âœ… APIä»•æ§˜ãŒ ${{ steps.latest_version.outputs.version }} ã«æ›´æ–°ã•ã‚Œã€ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ãŒã‚ã£ãŸãŸã‚PRãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
          fi
