name: è‡ªå‹•ã‚¿ã‚°ä½œæˆã¨ãƒªãƒªãƒ¼ã‚¹

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  auto-tag:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'api-update')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æœ€æ–°ã‚¿ã‚°ã‚’å–å¾—
        id: get_latest_tag
        run: |
          # æœ€æ–°ã®ã‚¿ã‚°ã‚’å–å¾—ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å½¢å¼: 0.yyyymmdd.patchï¼‰
          LATEST_TAG=$(git tag -l "v0.*" | sort -V | tail -1)
          
          if [ -z "$LATEST_TAG" ]; then
            # åˆå›ã®å ´åˆ
            echo "latest_tag=v0.20000101.0" >> $GITHUB_OUTPUT
            echo "previous_major=0" >> $GITHUB_OUTPUT  
            echo "previous_date=20000101" >> $GITHUB_OUTPUT
            echo "previous_patch=0" >> $GITHUB_OUTPUT
            echo "åˆå›ãƒªãƒªãƒ¼ã‚¹ã§ã™"
          else
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            
            # ã‚¿ã‚°ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º (v0.yyyymmdd.patch)
            VERSION_PART=$(echo $LATEST_TAG | sed 's/^v//')
            MAJOR=$(echo $VERSION_PART | cut -d. -f1)
            DATE=$(echo $VERSION_PART | cut -d. -f2)  
            PATCH=$(echo $VERSION_PART | cut -d. -f3)
            
            echo "previous_major=$MAJOR" >> $GITHUB_OUTPUT
            echo "previous_date=$DATE" >> $GITHUB_OUTPUT
            echo "previous_patch=$PATCH" >> $GITHUB_OUTPUT
            echo "æœ€æ–°ã‚¿ã‚°: $LATEST_TAG (Major: $MAJOR, Date: $DATE, Patch: $PATCH)"
          fi

      - name: APIä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
        id: get_api_version
        run: |
          # rest-api-specãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          if [ -d "rest-api-spec" ]; then
            API_VERSION=$(find rest-api-spec -maxdepth 1 -type d -name "20*" | sort -r | head -1 | xargs basename 2>/dev/null || echo "")
          else
            echo "âŒ rest-api-spec ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          if [ -z "$API_VERSION" ]; then
            echo "âŒ APIä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          echo "api_version=$API_VERSION" >> $GITHUB_OUTPUT
          echo "APIä»•æ§˜ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $API_VERSION"

      - name: srcå·®åˆ†ã‚’ãƒã‚§ãƒƒã‚¯
        id: check_src_changes
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.latest_tag }}"
          
          if [ "$LATEST_TAG" = "v0.20000101.0" ]; then
            # åˆå›ã®å ´åˆã¯å¿…ãšsrcå·®åˆ†ã‚ã‚Šã¨ã—ã¦æ‰±ã†
            echo "has_src_changes=true" >> $GITHUB_OUTPUT
            echo "åˆå›ãƒªãƒªãƒ¼ã‚¹ã®ãŸã‚ã€srcå·®åˆ†ã‚ã‚Šã¨ã—ã¦å‡¦ç†ã—ã¾ã™"
          else
            # å‰å›ã‚¿ã‚°ã‹ã‚‰ã®srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
            if git diff --quiet "$LATEST_TAG" HEAD -- src/; then
              echo "has_src_changes=false" >> $GITHUB_OUTPUT
              echo "srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            else
              echo "has_src_changes=true" >> $GITHUB_OUTPUT
              echo "srcãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å¤‰æ›´ãŒã‚ã‚Šã¾ã™"
              
              # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å–å¾—
              CHANGED_FILES=$(git diff --name-only "$LATEST_TAG" HEAD -- src/ | wc -l)
              echo "src_changed_files_count=$CHANGED_FILES" >> $GITHUB_OUTPUT
              echo "å¤‰æ›´ã•ã‚ŒãŸsrcãƒ•ã‚¡ã‚¤ãƒ«æ•°: $CHANGED_FILES"
            fi
          fi

      - name: æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨ˆç®—
        id: calculate_version
        run: |
          API_VERSION="${{ steps.get_api_version.outputs.api_version }}"
          PREVIOUS_DATE="${{ steps.get_latest_tag.outputs.previous_date }}"
          PREVIOUS_PATCH="${{ steps.get_latest_tag.outputs.previous_patch }}"
          HAS_SRC_CHANGES="${{ steps.check_src_changes.outputs.has_src_changes }}"
          
          if [ "$HAS_SRC_CHANGES" = "true" ]; then
            # srcå·®åˆ†ã‚ã‚Š: æ—¥ä»˜ã‚’æ›´æ–°ã—ã€patch=0
            NEW_VERSION="0.$API_VERSION.0"
            UPDATE_TYPE="major"
          else
            # srcå·®åˆ†ãªã—: æ—¥ä»˜ã¯ãã®ã¾ã¾ã€patch++
            NEW_PATCH=$((PREVIOUS_PATCH + 1))
            NEW_VERSION="0.$PREVIOUS_DATE.$NEW_PATCH"
            UPDATE_TYPE="patch"
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "update_type=$UPDATE_TYPE" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v$NEW_VERSION (æ›´æ–°ã‚¿ã‚¤ãƒ—: $UPDATE_TYPE)"

      - name: composer.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
        id: update_composer
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          
          # composer.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          jq --arg version "$NEW_VERSION" '.version = $version' composer.json > composer.json.tmp
          mv composer.json.tmp composer.json
          
          echo "composer.jsonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ $NEW_VERSION ã«æ›´æ–°ã—ã¾ã—ãŸ"

      - name: å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          UPDATE_TYPE="${{ steps.calculate_version.outputs.update_type }}"
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add composer.json
          git commit -m "bump version to $NEW_VERSION

- Update type: $UPDATE_TYPE
- API specification: ${{ steps.get_api_version.outputs.api_version }}
$(if [ "$UPDATE_TYPE" = "major" ]; then echo "- src changes: ${{ steps.check_src_changes.outputs.src_changed_files_count }} files"; fi)

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

      - name: ã‚¿ã‚°ã‚’ä½œæˆ
        id: create_tag
        run: |
          NEW_VERSION="${{ steps.calculate_version.outputs.new_version }}"
          UPDATE_TYPE="${{ steps.calculate_version.outputs.update_type }}"
          API_VERSION="${{ steps.get_api_version.outputs.api_version }}"
          
          TAG_NAME="v$NEW_VERSION"
          
          # ã‚¿ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
          if [ "$UPDATE_TYPE" = "major" ]; then
            TAG_MESSAGE="Kintone API Specification Update

Version: $NEW_VERSION
API Spec: $API_VERSION  
Type: API specification update with code changes
Changed files in src/: ${{ steps.check_src_changes.outputs.src_changed_files_count }}

ğŸ¤– Auto-generated release"
          else
            TAG_MESSAGE="Patch Release

Version: $NEW_VERSION
Type: Patch release (no src changes)

ğŸ¤– Auto-generated release"
          fi
          
          # ã‚¿ã‚°ã‚’ä½œæˆ
          git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
          git push origin "$TAG_NAME"
          
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ã‚¿ã‚° $TAG_NAME ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          name: "ğŸš€ Release ${{ steps.calculate_version.outputs.new_version }}"
          body: |
            ## ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ ${{ steps.calculate_version.outputs.new_version }}
            
            ### ğŸ“Š å¤‰æ›´å†…å®¹
            - **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: `${{ steps.calculate_version.outputs.new_version }}`
            - **APIä»•æ§˜**: `${{ steps.get_api_version.outputs.api_version }}`
            - **æ›´æ–°ã‚¿ã‚¤ãƒ—**: `${{ steps.calculate_version.outputs.update_type }}`
            ${{ steps.calculate_version.outputs.update_type == 'major' && format('- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: {0}å€‹', steps.check_src_changes.outputs.src_changed_files_count) || '- **å¤‰æ›´**: ãƒ‘ãƒƒãƒãƒªãƒªãƒ¼ã‚¹ï¼ˆsrcã«å¤‰æ›´ãªã—ï¼‰' }}
            
            ### ğŸ”— ãƒªãƒ³ã‚¯
            - [ğŸ“‹ APIä»•æ§˜ (kintone/rest-api-spec)](https://github.com/kintone/rest-api-spec)
            - [ğŸ“– Kintone REST API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.kintone.io/hc/ja/categories/18815983)
            - [ğŸ“¦ Packagist](https://packagist.org/packages/thecocojp/kintone-rest-api-client-php)
            
            ### ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
            ```bash
            composer require thecocojp/kintone-rest-api-client-php:${{ steps.calculate_version.outputs.new_version }}
            ```
            
            ---
            ğŸ¤– *è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒªãƒªãƒ¼ã‚¹*
          draft: false
          prerelease: false

      - name: å®Ÿè¡Œçµæœã‚’ã¾ã¨ã‚
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo ""
          echo "ğŸ“Š çµæœ:"
          echo "  - æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ steps.calculate_version.outputs.new_version }}"
          echo "  - æ›´æ–°ã‚¿ã‚¤ãƒ—: ${{ steps.calculate_version.outputs.update_type }}"  
          echo "  - APIä»•æ§˜: ${{ steps.get_api_version.outputs.api_version }}"
          echo "  - ã‚¿ã‚°: ${{ steps.create_tag.outputs.tag_name }}"
          echo ""
          echo "ğŸ”— ãƒªãƒªãƒ¼ã‚¹ãƒšãƒ¼ã‚¸: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.create_tag.outputs.tag_name }}"